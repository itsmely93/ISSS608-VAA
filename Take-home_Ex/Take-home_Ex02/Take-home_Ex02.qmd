---
title: "Take Home Exercise 2"
author: "Lim Li Ying"
date: "15 May 2023"
edit: visual
execute: 
  warning: false
---

# 1 The Task

With reference to [Mini Challenge 2 of the VAST Challenge 2023](https://vast-challenge.github.io/2023/MC2.html), the task is to use visual analytics to identify temporal patterns for individual entities and between entities in the knowledge graph FishEye created from trade records. Categorize the types of business relationship patterns you find.

# 2 The Data

The data sets were obtained from the VAST Challenge 2023 website, and includes a knowledge graph as well as 12 bundles consisting of link suggestions. As the objective states to use the knowledge graph created from trade records, only the *"mc2_challenge_graph.json"* data set will be used for the study.

# 3 Data Preparation

## 3.1 Installing and loading of R packages

In this exercise, the following R packages will be used:

1.  `tidyverse`: for data cleaning and manipulation.

2.  `lubridate`: for working with dates and time.

3.  `jsonlite`: for loading and reading of the *.json* file.

4.  `visNetwork`: for creating interactive network graphs.

5.  `ggraph`: an extension of `ggplot2` for the creation of network graphs.

The code chunk below uses `p_load()` of the *pacman* package to check if all the aforementioned packages are installed, and install the packages are yet to be installed. The packages are then loaded into the R environment.

```{r}
pacman::p_load(tidygraph, ggraph, visNetwork, lubridate, tidyverse, graphlayouts, jsonlite, igraph)
```

## 3.2 Importing and loading the data set

To import the data *"mc2_challenge_graph.json"* file into the R environment, `fromJSON()` of the *jsonlite* package is used, as seen in the code chunk below.

```{r}
MC2 <- fromJSON("data/mc2_challenge_graph.json")
```

The `glimpse()` function from the *dpylr* package is used to see a general overview of the data set.

```{r}
glimpse(MC2)
```

## 3.3 Extracting the nodes and edges

From the MC2 data set, the nodes and edges data frames are coerced into tibbles, using the `as_tibble()` function from the *tibble* package.

```{r}
MC2_nodes <- as_tibble(MC2$nodes) %>%
  select(id, rcvcountry, shpcountry)
```

```{r}
MC2_edges <- as_tibble(MC2$links) %>%
  select(source, target, arrivaldate, hscode, valueofgoods_omu, 
         volumeteu, weightkg, valueofgoodsusd) %>% 
  distinct()
```

## 3.4 Data Wrangling

### 3.4.1 Preparing of edges table

```{r}
glimpse(MC2_edges)
```

-   *arrivaldate* is currently formatted as `<chr>` data type, and needs to be converted to the `<date>` data type.

-   A new column for the year will need to be created.

```{r}
MC2_edges <- MC2_edges %>%
  mutate(ArrivalDate = ymd(arrivaldate)) %>%
  mutate(Year = year(ArrivalDate)) 
```

-   Using the `filter()` function, rows whereby the hscode is 306170 and the year is 2028 will be selected.
-   They will then be aggregated by source, target, hscode and year, using the `group_by()` function.
-   A new column *Weight* (i.e. the count) will be created using the `summarise()` function.
-   The `filter()` function is used again to select rows whereby the source is not the same as the target, and the weight is greater than 20.
-   Lastly, the groups will be ungrouped using the `ungroup()` function.

```{r}
MC2_edges_aggregated <- MC2_edges %>%
  filter(hscode == "306170" & Year == "2028") %>%
  group_by(source, target, hscode, Year) %>%
  summarise(Weight = n()) %>%
  filter(source!=target) %>%
  filter(Weight > 20) %>%
  ungroup()
```

### 3.5.2 Preparing the nodes table

To ensure that all the nodes are present in the *source* and *target* columns of the edges table, a new nodes data table will be used by extracting the values directly from the *source* and *target* columns.

```{r}
id1 <- MC2_edges_aggregated %>%
  select(source) %>%
  rename(id = source)
id2 <- MC2_edges_aggregated %>%
  select(target) %>%
  rename(id = target)
MC2_nodes_extracted <- rbind(id1, id2) %>%
  distinct()
```

### 3.5.3 Building the tidygraph data model

```{r}
MC2_graph <- tbl_graph(nodes = MC2_nodes_extracted,
                       edges = MC2_edges_aggregated, 
                       directed = TRUE)
```

```{r}
MC2_graph
```

# 4 Network graph visualization

## 4.1 Static network graph of fishing companies in 2028

```{r}
ggraph(MC2_graph, layout = "fr") +
  geom_edge_link(aes(width=Weight), 
                 alpha=0.2) +
  geom_node_point() +
  theme_graph()
```

The static network graph gives us a general overview of the network.

To get a better understanding on the relationships between the various fishing companies, an interactive network graph will be created using *visNetwork*.

## 4.2 Interactive network graph

### 4.2.1 Preparation of the nodes and edges

```{r}
MC2_nodes2 <- MC2_nodes_extracted %>%
  mutate(label = id) 

# Add degree (number of edges connected to each node) as a new column "value"
# This will change the size of the nodes according to the value
MC2_nodes2$value = degree(MC2_graph)

# Use colorRampPalette() function to get a gradient color palette 
eigScalePal <- colorRampPalette(c('#9fbac9','#003049'))

# Match palette to centrality vector
# This will change the color of the nodes based on centrality value
MC2_nodes2$color <- eigScalePal(7)[cut(eigen_centrality(MC2_graph)$vector, breaks = 7)]

MC2_nodes2$title = paste0("Company Name: ", MC2_nodes2$label)
```

```{r}
MC2_edges2 <- MC2_edges %>%
  rename(from = source) %>%
  rename(to = target) %>%
  filter(hscode == "306170") %>%
  group_by(from, to, Year) %>%
  summarise(value = n()) %>%
  filter(from!=to) %>%
  filter(value > 20) %>%
  ungroup()
```

### 4.2.2 Interactive network graph of fishing companies

::: panel-tabset
## 2028

```{r}
#| code-fold: true
MC2_edges2028 <- MC2_edges2 %>%
  filter(Year == "2028")

visNetwork(MC2_nodes2,
           MC2_edges2028,
           width = "100%", 
           main = "Network of fishing companies in 2028") %>%
  visIgraphLayout(layout = "layout_with_fr") %>%
  visEdges(arrows = "to") %>%
  visOptions(highlightNearest = list(enabled = T, hover = T),
             nodesIdSelection = TRUE) %>%
  visLayout(randomSeed = 123) 
```

Insights:

It can be observed that while there is one main network, there are 11 other clusters of fishing companies that are not part of the main network. In these 11 clusters, the target of shipments only receives them from one or two sources, while the sources themselves exclusively send their products to a single target.

The 11 clusters are as seen in the table below:

+--------------------------------------+-------------------------------------------------+
| Source                               | Target                                          |
+======================================+=================================================+
| Amerigo Dockyard S.p.A. Distribution | Shou gan Limited Liability Company Distribution |
+--------------------------------------+-------------------------------------------------+
| The Sealion Corporation              | Mar de la Luz Plc                               |
+--------------------------------------+-------------------------------------------------+
| bi mu yu Sagl Distribution           | -1203                                           |
+--------------------------------------+-------------------------------------------------+
| Noord Limited Liability Company Line | -1363                                           |
+--------------------------------------+-------------------------------------------------+
| 1 Ltd. Liability Co Cargo            | Himachal Pradesh BV Holdings                    |
|                                      |                                                 |
| Irish Scallop Corportation Transport |                                                 |
+--------------------------------------+-------------------------------------------------+
| Turkish Sword NV Ocean               | Rybachit Sagl and Son's                         |
|                                      |                                                 |
| Neptune's Realm NV Navigation        |                                                 |
+--------------------------------------+-------------------------------------------------+
| qing yu Ltd. Corporation             | Mar de Plata BV Marine                          |
+--------------------------------------+-------------------------------------------------+
| Mar de la Costa Sagl                 | 3 Oceanography OAO Marine life                  |
+--------------------------------------+-------------------------------------------------+
| suo yu GmbH & Co. KG Freight         | Selkie Ltd. Liability Co                        |
+--------------------------------------+-------------------------------------------------+
| Mar de la Felicidad NV               | Water Wonders AG Transport                      |
+--------------------------------------+-------------------------------------------------+
| OB River Ltd. Liability Co           | Kilimanjaro fishery Ltd. Corporation Carriers   |
+--------------------------------------+-------------------------------------------------+

## 2030

```{r}
#| code-fold: true
MC2_edges2030 <- MC2_edges2 %>%
  filter(Year == "2030")

visNetwork(MC2_nodes2,
           MC2_edges2030,
           width = "100%", 
           main = "Network of fishing companies in 2030") %>%
  visIgraphLayout(layout = "layout_with_fr") %>%
  visEdges(arrows = "to") %>%
  visOptions(highlightNearest = list(enabled = T, hover = T),
             nodesIdSelection = TRUE) %>%
  visLayout(randomSeed = 123) 
```

## 2032

```{r}
#| code-fold: true
MC2_edges2032 <- MC2_edges2 %>%
  filter(Year == "2032")

visNetwork(MC2_nodes2,
           MC2_edges2032,
           width = "100%", 
           main = "Network of fishing companies in 2032") %>%
  visIgraphLayout(layout = "layout_with_fr") %>%
  visEdges(arrows = "to") %>%
  visOptions(highlightNearest = list(enabled = T, hover = T),
             nodesIdSelection = TRUE) %>%
  visLayout(randomSeed = 123) 
```

## 2034

```{r}
#| code-fold: true
MC2_edges2034 <- MC2_edges2 %>%
  filter(Year == "2034")

visNetwork(MC2_nodes2,
           MC2_edges2034,
           width = "100%", 
           main = "Network of fishing companies in 2034") %>%
  visIgraphLayout(layout = "layout_with_fr") %>%
  visEdges(arrows = "to") %>%
  visOptions(highlightNearest = list(enabled = T, hover = T),
             nodesIdSelection = TRUE) %>%
  visLayout(randomSeed = 123) 
```
:::
